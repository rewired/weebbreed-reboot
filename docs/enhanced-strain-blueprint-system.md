# Enhanced Strain Blueprint System\n\nThis document describes the enhanced strain blueprint system that provides more realistic and detailed strain-specific environmental preferences, yield modeling, and cultivation method compatibility.\n\n## Overview\n\nThe enhanced strain system extends the basic strain blueprint with new fields that enable:\n- Phase-specific environmental preferences (seedling, veg, flower, ripening)\n- Stress tolerance modeling for environmental metrics\n- Cultivation method affinity scoring\n- Phase-specific durations for phenology\n- Advanced yield modeling with CO2 response curves\n\n## Core Components\n\n### 1. Enhanced Strain Blueprint\n\n**Location**: `src/backend/src/engine/strains/enhancedStrainInterface.ts`\n\nThe enhanced strain blueprint includes these new fields:\n\n`typescript\ninterface EnhancedStrainBlueprint {\n  // ... existing fields (id, name, genetics, etc.)\n  \n  // Environmental bands per phase\n  envBands?: {\n    default: EnvBands;\n    veg?: Partial<EnvBands>;\n    flower?: Partial<EnvBands>;\n  };\n  \n  // Stress tolerance per metric\n  stressTolerance?: {\n    temp_C?: number;\n    rh_frac?: number;\n    co2_ppm?: number;\n    ppfd_umol_m2s?: number;\n    vpd_kPa?: number;\n  };\n  \n  // Method compatibility\n  methodAffinity?: Record<string, number>; // method ID -> affinity (0-1)\n  \n  // Growth phase durations\n  phaseDurations?: {\n    seedling?: number;\n    veg?: number;\n    flower?: number;\n    ripening?: number;\n  };\n  \n  // Enhanced yield model\n  yieldModel?: {\n    baseGmPerPlant?: number;\n    qualityFactors?: {\n      temp?: number;\n      rh?: number;\n      ppfd?: number;\n      vpd?: number;\n    };\n    co2Response?: {\n      halfMax_ppm: number;\n      saturation_ppm: number;\n    };\n  };\n}\n`\n\n### 2. Environmental Evaluation Service\n\n**Location**: `src/backend/src/engine/strains/enhancedStrainService.ts`\n\nThe service provides methods for:\n- Evaluating zone environment against strain preferences\n- Calculating yield estimates based on environmental conditions\n- Determining cultivation method compatibility\n- Emitting environmental events for monitoring\n\n#### Key Methods:\n\n`typescript\n// Evaluate environment against strain bands\nevaluateEnvironment(\n  strain: EnhancedStrainBlueprint,\n  environment: ZoneEnvironmentState,\n  stage: PlantStage,\n  applyStressTolerance?: boolean\n): StrainEnvironmentResult\n\n// Calculate enhanced yield estimate\ncalculateYield(context: YieldCalculationContext): CalculatedYield\n\n// Get method compatibility rating\ngetMethodCompatibility(\n  strain: EnhancedStrainBlueprint,\n  methodId: string\n): MethodCompatibility\n`\n\n### 3. Plant Growth Integration\n\n**Location**: `src/backend/src/engine/strains/plantGrowthIntegration.ts`\n\nIntegrates the enhanced strain evaluation with the plant growth engine:\n- Calculates health and growth multipliers based on environmental stress\n- Provides phase-aware growth rate calculations\n- Generates yield estimates and environmental tooltips for the UI\n\n### 4. Frontend UI Component\n\n**Location**: `src/frontend/src/components/strain/StrainEnvironmentPanel.tsx`\n\nDisplays comprehensive strain environmental analysis including:\n- Overall stress level with color-coded indicators\n- Individual metric status (optimal, acceptable, stress, critical)\n- Yield estimates with breakdown of quality and CO2 multipliers\n- Method compatibility ratings\n- Environmental recommendations\n\n## Environmental Band System\n\n### Band Structure\n\n`typescript\ninterface EnvBand {\n  green: [number, number];    // Optimal range\n  yellowLow: number;          // Acceptable lower bound\n  yellowHigh: number;         // Acceptable upper bound\n}\n`\n\n### Phase Overrides\n\nStrains can define different environmental preferences for different growth phases:\n- **Default**: Base environmental preferences\n- **Veg**: Overrides for vegetative growth (often higher humidity, lower light)\n- **Flower**: Overrides for flowering phase (often lower humidity, higher light)\n\n### Evaluation Logic\n\n1. **Optimal (Green)**: Value falls within the green range\n2. **Acceptable (Yellow)**: Value falls between yellowLow and green[0], or between green[1] and yellowHigh\n3. **Stress (Orange)**: Value deviates moderately from acceptable range\n4. **Critical (Red)**: Value deviates severely from acceptable range\n\n### Stress Tolerance\n\nMature plants (>14 days) can apply stress tolerance, which widens the acceptable ranges:\n- Reduces yellowLow by tolerance amount\n- Increases yellowHigh by tolerance amount\n- Allows plants to better handle environmental fluctuations as they mature\n\n## Yield Modeling\n\n### Quality Factors\n\nEach environmental metric can contribute to yield quality:\n`typescript\nqualityFactors: {\n  temp: 0.3,     // Temperature contributes 30% to quality score\n  rh: 0.2,       // Humidity contributes 20%\n  ppfd: 0.4,     // Light contributes 40%\n  vpd: 0.1       // VPD contributes 10%\n}\n`\n\n### CO2 Response Curve\n\nModels diminishing returns for CO2 supplementation:\n- **halfMax_ppm**: CO2 level that gives 50% of maximum response\n- **saturation_ppm**: CO2 level beyond which no additional benefit occurs\n- Uses Michaelis-Menten kinetics for realistic CO2 response\n\n### Final Yield Calculation\n\n`\nEstimated Yield = Base Yield × Quality Multiplier × CO2 Multiplier\n`\n\n## Method Affinity System\n\n### Affinity Scores\n\nEach strain can define compatibility with cultivation methods:\n- **1.0**: Perfect compatibility\n- **0.8**: Good compatibility\n- **0.6**: Moderate compatibility\n- **0.4**: Poor compatibility\n- **0.2**: Very poor compatibility\n- **0.0**: Incompatible\n\n### Categories\n\n- **Excellent** (0.9+): Strain thrives with this method\n- **Good** (0.7-0.89): Strain performs well\n- **Neutral** (0.5-0.69): Strain is compatible but not optimal\n- **Poor** (0.3-0.49): Strain may struggle\n- **Incompatible** (<0.3): Not recommended\n\n## Example Usage\n\n### Backend Integration\n\n`typescript\n// In plant growth tick processing\nconst environmentResult = enhancedStrainService.evaluateEnvironment(\n  strain,\n  zoneEnvironment,\n  plant.stage,\n  plant.age_days > 14 // Apply stress tolerance for mature plants\n);\n\n// Calculate growth multipliers\nconst healthMultiplier = 1.0 - (environmentResult.overallStress * 0.3);\nconst growthRate = baseGrowthRate * healthMultiplier;\n\n// Emit monitoring events\nenhancedStrainService.emitEnvironmentalEvents(\n  plant.id,\n  plant.zone_id,\n  strain,\n  environmentResult,\n  currentTick,\n  eventCollector\n);\n`\n\n### Frontend Integration\n\n`tsx\n// Display strain environment analysis\n<StrainEnvironmentPanel\n  strainName=\"AK-47\"\n  environmentResult={environmentResult}\n  yieldEstimate={yieldEstimate}\n  methodCompatibility={methodCompatibility}\n  baseYield={120}\n/>\n`\n\n## Migration Path\n\n### Existing Strains\n\nStrains without enhanced fields will use fallback defaults:\n- Default environmental bands based on cannabis cultivation best practices\n- No stress tolerance (0 for all metrics)\n- No method affinity (assumes neutral compatibility)\n- Standard phase durations\n- Simple yield model without quality factors\n\n### Gradual Enhancement\n\nStrains can be enhanced incrementally:\n1. Add basic `envBands` with default values\n2. Add phase-specific overrides for `veg` and `flower`\n3. Configure `stressTolerance` based on strain resilience\n4. Define `methodAffinity` for cultivation methods\n5. Add `yieldModel` with quality factors and CO2 response\n\n## Benefits\n\n### Realism\n- Different strains now have unique environmental preferences\n- Phase-specific requirements (e.g., lower humidity in flower)\n- Realistic CO2 response curves\n- Method-specific compatibility\n\n### Gameplay\n- Strategic strain selection based on available equipment\n- Environmental optimization becomes strain-specific\n- Yield predictions become more accurate and meaningful\n- Player education about real cultivation practices\n\n### UI/UX\n- Rich environmental feedback with source attribution\n- Clear visual indicators for environmental status\n- Actionable recommendations for improvement\n- Detailed yield breakdowns showing impact of environment\n\n## Future Enhancements\n\n### Planned Features\n\n1. **Nutrient Affinity**: Strain preferences for different nutrient regimens\n2. **Training Response**: How well strains respond to LST, SCROG, etc.\n3. **Harvest Window**: Strain-specific ripening characteristics\n4. **Genetic Stability**: Phenotype variation modeling\n5. **Disease Resistance**: Environmental stress leading to pathogen susceptibility\n\n### Advanced Modeling\n\n1. **Multi-factor Interactions**: How temperature and humidity interact for VPD optimization\n2. **Seasonal Adaptation**: Strains that prefer different conditions at different times\n3. **Epigenetic Memory**: Plants \"remembering\" previous environmental stress\n4. **Breeding Integration**: Parent strain characteristics affecting offspring\n\nThis enhanced strain system provides a solid foundation for realistic, engaging, and educational cannabis cultivation simulation while maintaining backward compatibility with existing strain data.\n\n## Implementation Summary\n\n### Files Created\n\n1. **Enhanced AK-47 Blueprint**: `data/strains/ak-47-enhanced.json`\n - Complete strain blueprint with all new fields populated\n - Phase-specific environmental preferences\n - Stress tolerance configuration\n - Method affinity scores\n - Advanced yield model\n\n2. **Backend Schema**: `src/backend/src/schemas/strainsSchema.ts`\n - Zod validation schema for enhanced strain fields\n - Type-safe validation and parsing\n\n3. **Strain Interface**: `src/backend/src/engine/strains/enhancedStrainInterface.ts`\n - TypeScript interfaces and utility functions\n - Environmental evaluation logic\n - Phase mapping functions\n\n4. **Strain Service**: `src/backend/src/engine/strains/enhancedStrainService.ts`\n - Environmental evaluation service\n - Yield calculation engine\n - Method compatibility assessment\n - Event emission for monitoring\n\n5. **Growth Integration**: `src/backend/src/engine/strains/plantGrowthIntegration.ts`\n - Integration with plant growth engine\n - Health and growth multiplier calculations\n - UI tooltip generation\n\n6. **UI Component**: `src/frontend/src/components/strain/StrainEnvironmentPanel.tsx`\n - React component for environmental analysis display\n - Color-coded status indicators\n - Yield breakdown visualization\n - Environmental recommendations\n\nThe system is designed to be backward compatible, extensible, and provides a rich foundation for realistic cannabis cultivation simulation.
